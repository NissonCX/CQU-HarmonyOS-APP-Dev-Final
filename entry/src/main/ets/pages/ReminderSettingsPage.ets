/**
 * æé†’è®¾ç½®é¡µé¢
 * ç”¨äºŽç®¡ç†å„ç±»å¥åº·æé†’
 */
import { ReminderSettings, ReminderType } from '../models/HealthRecord';
import { DataManager } from '../utils/DataManager';
import { ThemeManager, ThemeColors, getThemeColors } from '../utils/ThemeManager';
import { ReminderManager } from '../utils/ReminderManager';
import { generateId } from '../utils/CommonUtils';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct ReminderSettingsPage {
  @State reminders: ReminderSettings[] = [];
  @StorageProp('themeChanged') @Watch('updateColors') themeChanged: number = 0;
  @State colors: ThemeColors = getThemeColors();
  @State showEditDialog: boolean = false;
  @State editingReminder: ReminderSettings | null = null;
  @State editMode: 'fixed' | 'interval' = 'fixed';
  @State editTime: string = '';
  @State editRepeatDays: number[] = [];
  @State editIntervalMinutes: number = 120;
  @State editStartTime: string = '08:00';
  @State editEndTime: string = '22:00';
  private dataManager: DataManager = DataManager.getInstance();
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private reminderManager: ReminderManager = ReminderManager.getInstance();

  async aboutToAppear() {
    // è¯·æ±‚é€šçŸ¥æƒé™
    await this.reminderManager.requestNotificationPermission();
    // åŠ è½½æé†’è®¾ç½®
    this.loadReminders();
  }

  /**
   * åŠ è½½æé†’è®¾ç½®
   */
  async loadReminders() {
    this.reminders = await this.dataManager.getAllReminders();
    // å¦‚æžœæ²¡æœ‰æé†’ï¼Œåˆå§‹åŒ–é»˜è®¤æé†’
    if (this.reminders.length === 0) {
      await this.initDefaultReminders();
      this.reminders = await this.dataManager.getAllReminders();
    }
  }

  /**
   * åˆå§‹åŒ–é»˜è®¤æé†’
   */
  async initDefaultReminders() {
    const defaultReminders: ReminderSettings[] = [
      {
        id: generateId(),
        type: ReminderType.DAILY_RECORD,
        enabled: false,
        mode: 'fixed',
        time: '21:00',
        repeatDays: [1, 2, 3, 4, 5, 6, 0], // æ¯å¤©
        title: 'è®°å½•ä»Šæ—¥æ•°æ®',
        content: 'åˆ«å¿˜äº†è®°å½•ä»Šå¤©çš„å¥åº·æ•°æ®å“¦~'
      },
      {
        id: generateId(),
        type: ReminderType.DRINK_WATER,
        enabled: false,
        mode: 'interval',
        intervalMinutes: 120,  // æ¯2å°æ—¶æé†’ä¸€æ¬¡
        startTime: '08:00',    // æ—©ä¸Š8ç‚¹å¼€å§‹
        endTime: '22:00',      // æ™šä¸Š10ç‚¹ç»“æŸ
        title: 'å–æ°´æé†’',
        content: 'è¯¥å–æ°´äº†ï¼Œä¿æŒå……è¶³çš„æ°´åˆ†æ‘„å…¥~'
      },
      {
        id: generateId(),
        type: ReminderType.EXERCISE,
        enabled: false,
        mode: 'fixed',
        time: '18:00',
        repeatDays: [1, 2, 3, 4, 5], // å·¥ä½œæ—¥
        title: 'è¿åŠ¨æé†’',
        content: 'è¯¥è¿åŠ¨äº†ï¼ŒåŠ¨èµ·æ¥è®©èº«ä½“æ›´å¥åº·~'
      },
      {
        id: generateId(),
        type: ReminderType.SLEEP,
        enabled: false,
        mode: 'fixed',
        time: '22:30',
        repeatDays: [1, 2, 3, 4, 5, 6, 0], // æ¯å¤©
        title: 'ç¡çœ æé†’',
        content: 'è¯¥ä¼‘æ¯äº†ï¼Œå……è¶³çš„ç¡çœ å¾ˆé‡è¦~'
      }
    ];

    for (const reminder of defaultReminders) {
      await this.dataManager.saveReminder(reminder);
    }
  }

  /**
   * æ›´æ–°ä¸»é¢˜é¢œè‰²
   */
  updateColors() {
    this.colors = getThemeColors();
  }

  /**
   * åˆ‡æ¢æé†’å¼€å…³
   */
  async toggleReminder(reminder: ReminderSettings, index: number) {
    // ç›´æŽ¥ä¿®æ”¹çŠ¶æ€æ•°ç»„ä¸­çš„å¯¹è±¡
    this.reminders[index].enabled = !this.reminders[index].enabled;

    // ä¿å­˜åˆ°æ•°æ®åº“
    await this.dataManager.saveReminder(this.reminders[index]);

    // å‘å¸ƒæˆ–å–æ¶ˆç³»ç»Ÿæé†’
    if (this.reminders[index].enabled) {
      const success = await this.reminderManager.publishReminder(this.reminders[index]);
      if (!success) {
        // å‘å¸ƒå¤±è´¥ï¼Œå›žæ»šçŠ¶æ€
        this.reminders[index].enabled = false;
        await this.dataManager.saveReminder(this.reminders[index]);
        promptAction.showToast({
          message: 'æé†’è®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™',
          duration: 2000
        });
      } else {
        promptAction.showToast({
          message: 'æé†’å·²å¼€å¯',
          duration: 1500
        });
      }
    } else {
      await this.reminderManager.cancelReminder(this.reminders[index].id);
      promptAction.showToast({
        message: 'æé†’å·²å…³é—­',
        duration: 1500
      });
    }

    // è§¦å‘UIæ›´æ–° - åˆ›å»ºæ–°æ•°ç»„å¼•ç”¨
    this.reminders = [...this.reminders];
  }

  /**
   * ç¼–è¾‘æé†’
   */
  editReminder(reminder: ReminderSettings) {
    this.editingReminder = reminder;
    this.editMode = reminder.mode;

    if (reminder.mode === 'fixed') {
      this.editTime = reminder.time || '';
      this.editRepeatDays = reminder.repeatDays ? [...reminder.repeatDays] : [];
    } else {
      this.editIntervalMinutes = reminder.intervalMinutes || 120;
      this.editStartTime = reminder.startTime || '08:00';
      this.editEndTime = reminder.endTime || '22:00';
    }

    this.showEditDialog = true;
  }

  /**
   * ä¿å­˜ç¼–è¾‘
   */
  async saveEdit() {
    if (this.editingReminder) {
      const wasEnabled = this.editingReminder.enabled;

      this.editingReminder.mode = this.editMode;

      if (this.editMode === 'fixed') {
        this.editingReminder.time = this.editTime;
        this.editingReminder.repeatDays = [...this.editRepeatDays];
        // æ¸…ç©ºé—´éš”æ¨¡å¼çš„å­—æ®µ
        this.editingReminder.intervalMinutes = undefined;
        this.editingReminder.startTime = undefined;
        this.editingReminder.endTime = undefined;
      } else {
        this.editingReminder.intervalMinutes = this.editIntervalMinutes;
        this.editingReminder.startTime = this.editStartTime;
        this.editingReminder.endTime = this.editEndTime;
        // æ¸…ç©ºå›ºå®šæ—¶é—´æ¨¡å¼çš„å­—æ®µ
        this.editingReminder.time = undefined;
        this.editingReminder.repeatDays = undefined;
      }

      await this.dataManager.saveReminder(this.editingReminder);

      // å¦‚æžœæé†’å·²å¼€å¯ï¼Œéœ€è¦é‡æ–°å‘å¸ƒ
      if (wasEnabled) {
        await this.reminderManager.cancelReminder(this.editingReminder.id);
        const success = await this.reminderManager.publishReminder(this.editingReminder);
        if (!success) {
          promptAction.showToast({
            message: 'æé†’è®¾ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™',
            duration: 2000
          });
        }
      }

      // è§¦å‘UIæ›´æ–°
      this.reminders = [...this.reminders];

      promptAction.showToast({
        message: 'ä¿å­˜æˆåŠŸ',
        duration: 1500
      });

      this.showEditDialog = false;
    }
  }

  /**
   * å–æ¶ˆç¼–è¾‘
   */
  cancelEdit() {
    this.showEditDialog = false;
    this.editingReminder = null;
  }

  /**
   * åˆ‡æ¢é‡å¤æ—¥æœŸ
   */
  toggleRepeatDay(day: number) {
    const index = this.editRepeatDays.indexOf(day);
    if (index >= 0) {
      this.editRepeatDays.splice(index, 1);
    } else {
      this.editRepeatDays.push(day);
    }
    this.editRepeatDays = [...this.editRepeatDays];
  }

  /**
   * é€‰æ‹©æ‰€æœ‰æ—¥æœŸ
   */
  selectAllDays() {
    this.editRepeatDays = [1, 2, 3, 4, 5, 6, 0];
  }

  /**
   * é€‰æ‹©å·¥ä½œæ—¥
   */
  selectWorkdays() {
    this.editRepeatDays = [1, 2, 3, 4, 5];
  }

  /**
   * é€‰æ‹©å‘¨æœ«
   */
  selectWeekends() {
    this.editRepeatDays = [0, 6];
  }

  /**
   * èŽ·å–æé†’ç±»åž‹åç§°
   */
  getReminderTypeName(type: ReminderType): string {
    switch (type) {
      case ReminderType.DAILY_RECORD:
        return 'æ¯æ—¥è®°å½•';
      case ReminderType.DRINK_WATER:
        return 'å–æ°´æé†’';
      case ReminderType.EXERCISE:
        return 'è¿åŠ¨æé†’';
      case ReminderType.SLEEP:
        return 'ç¡çœ æé†’';
      case ReminderType.MEDICINE:
        return 'ç”¨è¯æé†’';
      default:
        return 'æœªçŸ¥æé†’';
    }
  }

  /**
   * èŽ·å–æé†’ç±»åž‹å›¾æ ‡
   */
  getReminderTypeIcon(type: ReminderType): string {
    switch (type) {
      case ReminderType.DAILY_RECORD:
        return 'ðŸ“';
      case ReminderType.DRINK_WATER:
        return 'ðŸ’§';
      case ReminderType.EXERCISE:
        return 'ðŸƒ';
      case ReminderType.SLEEP:
        return 'ðŸŒ™';
      case ReminderType.MEDICINE:
        return 'ðŸ’Š';
      default:
        return 'ðŸ””';
    }
  }

  /**
   * æ ¼å¼åŒ–é‡å¤æ—¥æœŸ
   */
  formatRepeatDays(repeatDays?: number[]): string {
    if (!repeatDays || repeatDays.length === 0) {
      return '';
    }

    if (repeatDays.length === 7) {
      return 'æ¯å¤©';
    }

    const workdays = [1, 2, 3, 4, 5];
    const isWorkdays = workdays.every(day => repeatDays.includes(day)) &&
                       !repeatDays.includes(0) &&
                       !repeatDays.includes(6);
    if (isWorkdays) {
      return 'å·¥ä½œæ—¥';
    }

    const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    return repeatDays.sort().map(day => dayNames[day]).join(', ');
  }

  /**
   * æ ¼å¼åŒ–æé†’æ—¶é—´ä¿¡æ¯
   */
  formatReminderTime(reminder: ReminderSettings): string {
    if (reminder.mode === 'interval') {
      // æ£€æŸ¥å¿…è¦å­—æ®µæ˜¯å¦å­˜åœ¨
      if (!reminder.intervalMinutes) {
        return 'é—´éš”æ—¶é—´æœªè®¾ç½®';
      }
      
      const hours = Math.floor(reminder.intervalMinutes / 60);
      const minutes = reminder.intervalMinutes % 60;
      let intervalText = '';
      
      if (hours > 0) {
        intervalText = `æ¯${hours}å°æ—¶`;
        if (minutes > 0) {
          intervalText += `${minutes}åˆ†é’Ÿ`;
        }
      } else {
        // ç¡®ä¿è‡³å°‘æ˜¾ç¤ºåˆ†é’Ÿæ•°
        intervalText = `æ¯${minutes}åˆ†é’Ÿ`;
      }
      
      // æ£€æŸ¥å¼€å§‹å’Œç»“æŸæ—¶é—´æ˜¯å¦å­˜åœ¨
      const startTime = reminder.startTime || 'æœªè®¾ç½®';
      const endTime = reminder.endTime || 'æœªè®¾ç½®';
      
      return `${intervalText} (${startTime}-${endTime})`;
    } else {
      return reminder.time || 'æ—¶é—´æœªè®¾ç½®';
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('â†')
          .fontSize(24)
          .fontColor(this.colors.textPrimary)
          .onClick(() => {
            router.back();
          })

        Text('æé†’è®¾ç½®')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.colors.textPrimary)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        Text(' ')
          .fontSize(24)
          .width(24) // å ä½ä¿æŒå±…ä¸­
      }
      .width('100%')
      .height(60)
      .padding({ left: 20, right: 20 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .backgroundColor(this.colors.surface)

      Scroll() {
        Column() {
          // æç¤ºä¿¡æ¯
          Column() {
            Text('ðŸ’¡ è®¾ç½®å¥åº·æé†’')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.colors.textPrimary)
              .margin({ bottom: 8 })
              .alignSelf(ItemAlign.Start)

            Text('å¼€å¯æé†’åŽï¼Œåº”ç”¨ä¼šåœ¨æŒ‡å®šæ—¶é—´å‘ä½ å‘é€é€šçŸ¥ï¼Œå¸®åŠ©ä½ å…»æˆè‰¯å¥½çš„å¥åº·ä¹ æƒ¯ã€‚')
              .fontSize(14)
              .fontColor(this.colors.textSecondary)
              .lineHeight(22)
          }
          .width('100%')
          .padding(16)
          .backgroundColor(this.themeManager.isDark() ? this.colors.surfaceVariant : '#E8F5FF')
          .borderRadius(12)
          .margin({ bottom: 20 })

          // æé†’åˆ—è¡¨
          if (this.reminders.length === 0) {
            this.buildEmptyState()
          } else {
            ForEach(this.reminders, (reminder: ReminderSettings, index: number) => {
              this.buildReminderItem(reminder, index);
            }, (reminder: ReminderSettings) => reminder.id)
          }
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)

      // ç¼–è¾‘å¯¹è¯æ¡†
      if (this.showEditDialog && this.editingReminder) {
        this.buildEditDialog()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.colors.background)
  }

  /**
   * æž„å»ºç©ºçŠ¶æ€
   */
  @Builder
  buildEmptyState() {
    Column() {
      Text('ðŸ””')
        .fontSize(48)
        .margin({ bottom: 12 })

      Text('æš‚æ— æé†’')
        .fontSize(16)
        .fontColor(this.colors.textSecondary)
    }
    .width('100%')
    .padding({ top: 60, bottom: 60 })
    .justifyContent(FlexAlign.Center)
  }

  /**
   * æž„å»ºæé†’é¡¹
   */
  @Builder
  buildReminderItem(reminder: ReminderSettings, index: number) {
    Column() {
      Row() {
        // å·¦ä¾§å›¾æ ‡å’Œä¿¡æ¯
        Row() {
          Text(this.getReminderTypeIcon(reminder.type))
            .fontSize(32)
            .margin({ right: 12 })

          Column() {
            Text(this.getReminderTypeName(reminder.type))
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.colors.textPrimary)
              .alignSelf(ItemAlign.Start)

            Text(reminder.content)
              .fontSize(13)
              .fontColor(this.colors.textSecondary)
              .margin({ top: 4 })
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .alignSelf(ItemAlign.Start)
          }
          .alignItems(HorizontalAlign.Start)
          .layoutWeight(1)
        }
        .layoutWeight(1)

        // å³ä¾§å¼€å…³
        Toggle({ type: ToggleType.Switch, isOn: reminder.enabled })
          .selectedColor(this.colors.primary)
          .onChange((isOn: boolean) => {
            this.toggleReminder(reminder, index);
          })
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ—¶é—´å’Œé‡å¤ä¿¡æ¯ - å§‹ç»ˆæ˜¾ç¤º
      Column() {
        // æ—¶é—´ä¿¡æ¯è¡Œ
        Row() {
          Text('ðŸ•')
            .fontSize(14)
            .margin({ right: 6 })

          Text(this.formatReminderTime(reminder))
            .fontSize(14)
            .fontColor(this.colors.textSecondary)
        }
        .alignSelf(ItemAlign.Start)

        // é‡å¤æ—¥æœŸè¡Œï¼ˆä»…å›ºå®šæ—¶é—´æ¨¡å¼æ˜¾ç¤ºï¼‰
        if (reminder.mode === 'fixed' && reminder.repeatDays) {
          Row() {
            Text('ðŸ“…')
              .fontSize(14)
              .margin({ right: 6 })

            Text(this.formatRepeatDays(reminder.repeatDays))
              .fontSize(14)
              .fontColor(this.colors.textSecondary)
          }
          .alignSelf(ItemAlign.Start)
          .margin({ top: 6 })
        }

        // æé†’æ¨¡å¼æ ‡ç­¾
        Text(reminder.mode === 'interval' ? 'é—´éš”æé†’' : 'å®šæ—¶æé†’')
          .fontSize(12)
          .fontColor(this.colors.textInverse)
          .backgroundColor(reminder.mode === 'interval' ? this.colors.secondary : this.colors.primary)
          .padding({ left: 8, right: 8, top: 2, bottom: 2 })
          .borderRadius(4)
          .margin({ top: 8 })
          .alignSelf(ItemAlign.Start)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)

      // ç¼–è¾‘æŒ‰é’® - å§‹ç»ˆæ˜¾ç¤º
      Text('ç¼–è¾‘')
        .fontSize(14)
        .fontColor(this.colors.primary)
        .margin({ top: 12 })
        .onClick(() => {
          this.editReminder(reminder);
        })
        .alignSelf(ItemAlign.End)
    }
    .width('100%')
    .padding(16)
    .backgroundColor(this.colors.surface)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({
      radius: 8,
      color: this.colors.shadow,
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * æž„å»ºç¼–è¾‘å¯¹è¯æ¡†
   */
  @Builder
  buildEditDialog() {
    Stack() {
      // é®ç½©å±‚
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .onClick(() => {
          this.cancelEdit();
        })

      // å¯¹è¯æ¡†å†…å®¹
      Column() {
        // å¯¹è¯æ¡†æ ‡é¢˜
        Row() {
          Text('ç¼–è¾‘æé†’')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.colors.textPrimary)
            .layoutWeight(1)

          Text('âœ•')
            .fontSize(24)
            .fontColor(this.colors.textSecondary)
            .onClick(() => {
              this.cancelEdit();
            })
        }
        .width('100%')
        .padding(16)
        .justifyContent(FlexAlign.SpaceBetween)
        .backgroundColor(this.colors.surface)

        Scroll() {
          Column() {
            // æé†’ç±»åž‹
            Column() {
              Text('æé†’ç±»åž‹')
                .fontSize(14)
                .fontColor(this.colors.textSecondary)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              Row() {
                Text(this.getReminderTypeIcon(this.editingReminder!.type))
                  .fontSize(24)
                  .margin({ right: 8 })

                Text(this.getReminderTypeName(this.editingReminder!.type))
                  .fontSize(16)
                  .fontColor(this.colors.textPrimary)
              }
              .width('100%')
              .padding(12)
              .backgroundColor(this.colors.surfaceVariant)
              .borderRadius(8)
            }
            .width('100%')
            .margin({ bottom: 20 })

            // æé†’æ¨¡å¼é€‰æ‹©
            Column() {
              Text('æé†’æ¨¡å¼')
                .fontSize(14)
                .fontColor(this.colors.textSecondary)
                .alignSelf(ItemAlign.Start)
                .margin({ bottom: 8 })

              Row() {
                // å®šæ—¶æé†’æŒ‰é’®
                Text('å®šæ—¶æé†’')
                  .fontSize(15)
                  .fontColor(this.editMode === 'fixed' ? this.colors.textInverse : this.colors.textPrimary)
                  .backgroundColor(this.editMode === 'fixed' ? this.colors.primary : this.colors.surface)
                  .padding(12)
                  .borderRadius(8)
                  .layoutWeight(1)
                  .textAlign(TextAlign.Center)
                  .border({
                    width: 2,
                    color: this.editMode === 'fixed' ? this.colors.primary : this.colors.border
                  })
                  .onClick(() => {
                    this.editMode = 'fixed';
                  })

                // é—´éš”æé†’æŒ‰é’®
                Text('é—´éš”æé†’')
                  .fontSize(15)
                  .fontColor(this.editMode === 'interval' ? this.colors.textInverse : this.colors.textPrimary)
                  .backgroundColor(this.editMode === 'interval' ? this.colors.secondary : this.colors.surface)
                  .padding(12)
                  .borderRadius(8)
                  .layoutWeight(1)
                  .textAlign(TextAlign.Center)
                  .border({
                    width: 2,
                    color: this.editMode === 'interval' ? this.colors.secondary : this.colors.border
                  })
                  .onClick(() => {
                    this.editMode = 'interval';
                  })
                  .margin({ left: 12 })
              }
              .width('100%')
            }
            .width('100%')
            .margin({ bottom: 20 })

            // å®šæ—¶æé†’è®¾ç½®
            if (this.editMode === 'fixed') {
              Column() {
                // æé†’æ—¶é—´
                Column() {
                  Text('æé†’æ—¶é—´')
                    .fontSize(14)
                    .fontColor(this.colors.textSecondary)
                    .alignSelf(ItemAlign.Start)
                    .margin({ bottom: 8 })

                  Row() {
                    Text('ðŸ•')
                      .fontSize(20)
                      .margin({ right: 8 })

                    TextInput({ text: this.editTime, placeholder: 'è¯·è¾“å…¥æ—¶é—´ (HH:mm)' })
                      .layoutWeight(1)
                      .height(44)
                      .fontSize(16)
                      .backgroundColor(this.colors.surfaceVariant)
                      .borderRadius(8)
                      .onChange((value: string) => {
                        this.editTime = value;
                      })
                  }
                  .width('100%')
                }
                .width('100%')
                .margin({ bottom: 20 })

                // é‡å¤è®¾ç½®
                this.buildRepeatDaysSection()
              }
              .width('100%')
            }

            // é—´éš”æé†’è®¾ç½®
            if (this.editMode === 'interval') {
              Column() {
                // é—´éš”æ—¶é—´
                Column() {
                  Text('æé†’é—´éš”')
                    .fontSize(14)
                    .fontColor(this.colors.textSecondary)
                    .alignSelf(ItemAlign.Start)
                    .margin({ bottom: 8 })

                  Row() {
                    Text('â±ï¸')
                      .fontSize(20)
                      .margin({ right: 8 })

                    TextInput({
                      text: this.editIntervalMinutes.toString(),
                      placeholder: 'è¾“å…¥åˆ†é’Ÿæ•°'
                    })
                      .layoutWeight(1)
                      .height(44)
                      .fontSize(16)
                      .type(InputType.Number)
                      .backgroundColor(this.colors.surfaceVariant)
                      .borderRadius(8)
                      .onChange((value: string) => {
                        this.editIntervalMinutes = parseInt(value) || 120;
                      })

                    Text('åˆ†é’Ÿ')
                      .fontSize(14)
                      .fontColor(this.colors.textSecondary)
                      .margin({ left: 8 })
                  }
                  .width('100%')
                }
                .width('100%')
                .margin({ bottom: 16 })

                // å¿«æ·é—´éš”æŒ‰é’®
                Row() {
                  Text('30åˆ†é’Ÿ')
                    .fontSize(13)
                    .fontColor(this.colors.primary)
                    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                    .backgroundColor(this.colors.surface)
                    .borderRadius(6)
                    .border({ width: 1, color: this.colors.border })
                    .onClick(() => {
                      this.editIntervalMinutes = 30;
                    })

                  Text('1å°æ—¶')
                    .fontSize(13)
                    .fontColor(this.colors.primary)
                    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                    .backgroundColor(this.colors.surface)
                    .borderRadius(6)
                    .border({ width: 1, color: this.colors.border })
                    .margin({ left: 8 })
                    .onClick(() => {
                      this.editIntervalMinutes = 60;
                    })

                  Text('2å°æ—¶')
                    .fontSize(13)
                    .fontColor(this.colors.primary)
                    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                    .backgroundColor(this.colors.surface)
                    .borderRadius(6)
                    .border({ width: 1, color: this.colors.border })
                    .margin({ left: 8 })
                    .onClick(() => {
                      this.editIntervalMinutes = 120;
                    })

                  Text('3å°æ—¶')
                    .fontSize(13)
                    .fontColor(this.colors.primary)
                    .padding({ left: 10, right: 10, top: 6, bottom: 6 })
                    .backgroundColor(this.colors.surface)
                    .borderRadius(6)
                    .border({ width: 1, color: this.colors.border })
                    .margin({ left: 8 })
                    .onClick(() => {
                      this.editIntervalMinutes = 180;
                    })
                }
                .width('100%')
                .margin({ bottom: 20 })

                // ç”Ÿæ•ˆæ—¶é—´æ®µ
                Column() {
                  Text('ç”Ÿæ•ˆæ—¶é—´æ®µ')
                    .fontSize(14)
                    .fontColor(this.colors.textSecondary)
                    .alignSelf(ItemAlign.Start)
                    .margin({ bottom: 8 })

                  Row() {
                    // å¼€å§‹æ—¶é—´
                    Row() {
                      Text('ä»Ž')
                        .fontSize(14)
                        .fontColor(this.colors.textSecondary)
                        .margin({ right: 6 })

                      TextInput({ text: this.editStartTime, placeholder: 'HH:mm' })
                        .layoutWeight(1)
                        .height(40)
                        .fontSize(15)
                        .backgroundColor(this.colors.surfaceVariant)
                        .borderRadius(6)
                        .onChange((value: string) => {
                          this.editStartTime = value;
                        })
                    }
                    .layoutWeight(1)

                    Text('-')
                      .fontSize(16)
                      .fontColor(this.colors.textSecondary)
                      .margin({ left: 8, right: 8 })

                    // ç»“æŸæ—¶é—´
                    Row() {
                      Text('è‡³')
                        .fontSize(14)
                        .fontColor(this.colors.textSecondary)
                        .margin({ right: 6 })

                      TextInput({ text: this.editEndTime, placeholder: 'HH:mm' })
                        .layoutWeight(1)
                        .height(40)
                        .fontSize(15)
                        .backgroundColor(this.colors.surfaceVariant)
                        .borderRadius(6)
                        .onChange((value: string) => {
                          this.editEndTime = value;
                        })
                    }
                    .layoutWeight(1)
                  }
                  .width('100%')
                }
                .width('100%')
              }
              .width('100%')
            }

            // æç¤ºä¿¡æ¯
            if (this.editingReminder) {
              Column() {
                Text(this.editingReminder.content)
                  .fontSize(13)
                  .fontColor(this.colors.textSecondary)
                  .lineHeight(20)
              }
              .width('100%')
              .padding(12)
              .backgroundColor(this.themeManager.isDark() ? this.colors.surfaceVariant : '#E8F5FF')
              .borderRadius(8)
              .margin({ bottom: 20 })
            }
          }
          .width('100%')
          .padding(16)
        }
        .layoutWeight(1)
        .scrollBar(BarState.Auto)

        // åº•éƒ¨æŒ‰é’®
        Row() {
          Button('å–æ¶ˆ')
            .fontSize(16)
            .fontColor(this.colors.textSecondary)
            .backgroundColor(this.colors.surfaceVariant)
            .width('48%')
            .height(44)
            .onClick(() => {
              this.cancelEdit();
            })

          Button('ä¿å­˜')
            .fontSize(16)
            .fontColor(this.colors.textInverse)
            .backgroundColor(this.colors.primary)
            .width('48%')
            .height(44)
            .onClick(() => {
              this.saveEdit();
            })
        }
        .width('100%')
        .padding(16)
        .justifyContent(FlexAlign.SpaceBetween)
        .backgroundColor(this.colors.surface)
      }
      .width('90%')
      .height('70%')
      .backgroundColor(this.colors.background)
      .borderRadius(16)
      .shadow({
        radius: 24,
        color: '#40000000',
        offsetX: 0,
        offsetY: 8
      })
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
  }

  /**
   * æž„å»ºé‡å¤æ—¥æœŸé€‰æ‹©åŒºåŸŸ
   */
  @Builder
  buildRepeatDaysSection() {
    Column() {
      Row() {
        Text('é‡å¤æ—¥æœŸ')
          .fontSize(14)
          .fontColor(this.colors.textSecondary)
          .layoutWeight(1)

        // å¿«æ·æŒ‰é’®
        Row() {
          Text('æ¯å¤©')
            .fontSize(12)
            .fontColor(this.colors.primary)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(this.colors.surface)
            .borderRadius(4)
            .onClick(() => {
              this.selectAllDays();
            })
            .margin({ right: 6 })

          Text('å·¥ä½œæ—¥')
            .fontSize(12)
            .fontColor(this.colors.primary)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(this.colors.surface)
            .borderRadius(4)
            .onClick(() => {
              this.selectWorkdays();
            })
            .margin({ right: 6 })

          Text('å‘¨æœ«')
            .fontSize(12)
            .fontColor(this.colors.primary)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .backgroundColor(this.colors.surface)
            .borderRadius(4)
            .onClick(() => {
              this.selectWeekends();
            })
        }
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ˜ŸæœŸé€‰æ‹©å™¨
      Row() {
        this.buildDayButton('å‘¨ä¸€', 1)
        this.buildDayButton('å‘¨äºŒ', 2)
        this.buildDayButton('å‘¨ä¸‰', 3)
        this.buildDayButton('å‘¨å››', 4)
        this.buildDayButton('å‘¨äº”', 5)
        this.buildDayButton('å‘¨å…­', 6)
        this.buildDayButton('å‘¨æ—¥', 0)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
  }

  /**
   * æž„å»ºæ˜ŸæœŸæŒ‰é’®
   */
  @Builder
  buildDayButton(label: string, day: number) {
    Text(label)
      .fontSize(13)
      .fontColor(this.editRepeatDays.includes(day) ? this.colors.textInverse : this.colors.textPrimary)
      .backgroundColor(this.editRepeatDays.includes(day) ? this.colors.primary : this.colors.surface)
      .width(45)
      .height(45)
      .textAlign(TextAlign.Center)
      .borderRadius(22.5)
      .border({
        width: 2,
        color: this.editRepeatDays.includes(day) ? this.colors.primary : this.colors.border
      })
      .onClick(() => {
        this.toggleRepeatDay(day);
      })
  }
}
