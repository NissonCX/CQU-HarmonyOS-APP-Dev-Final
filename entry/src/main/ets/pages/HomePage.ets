/**
 * ä¸»é¡µé¢ - ä»Šæ—¥å¥åº·æ•°æ®æ¦‚è§ˆ
 * å±•ç¤ºä»Šæ—¥å¥åº·æ•°æ®å¿«é€Ÿå½•å…¥å’Œæ¦‚è§ˆä¿¡æ¯
 */
import { HealthRecord } from '../models/HealthRecord';
import { DataManager } from '../utils/DataManager';
import { formatDate, calculateBMI, getBMICategory, updateGoalsProgress } from '../utils/CommonUtils';
import { ThemeManager, ThemeColors, getThemeColors } from '../utils/ThemeManager';
import router from '@ohos.router';

@Component
export struct HomePage {
  @State todayRecord: HealthRecord | null = null;
  @State currentDate: string = '';
  @State bmi: number = 0;
  @State bmiCategory: string = '';
  @State isLoading: boolean = false;
  @State scaleValues: number[] = [1, 1, 1, 1, 1, 1]; // ç”¨äºå¡ç‰‡åŠ¨ç”»
  @StorageProp('themeChanged') @Watch('updateColors') themeChanged: number = 0;
  @State colors: ThemeColors = getThemeColors();
  private dataManager: DataManager = DataManager.getInstance();
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private intervalId: number = -1;

  aboutToAppear() {
    this.currentDate = formatDate(new Date());
    this.loadTodayData();
    // å¯åŠ¨å¡ç‰‡å…¥åœºåŠ¨ç”»
    this.animateCards();
    // å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆæ¯5ç§’ï¼‰
    this.intervalId = setInterval(() => {
      this.loadTodayData();
    }, 5000);
  }

  aboutToDisappear() {
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.intervalId !== -1) {
      clearInterval(this.intervalId);
    }
  }

  /**
   * å¯åŠ¨å¡ç‰‡å…¥åœºåŠ¨ç”»
   */
  animateCards() {
    this.scaleValues.forEach((_, index) => {
      setTimeout(() => {
        this.scaleValues[index] = 1.05;
        setTimeout(() => {
          this.scaleValues[index] = 1;
        }, 200);
      }, index * 100);
    });
  }

  /**
   * åŠ è½½ä»Šæ—¥æ•°æ®
   */
  async loadTodayData() {
    this.isLoading = true;

    // æ›´æ–°ç›®æ ‡è¿›åº¦
    await updateGoalsProgress();

    const record = await this.dataManager.getHealthRecordByDate(this.currentDate);
    this.todayRecord = record;

    // è®¡ç®—BMI
    if (record?.weight && record?.height) {
      this.bmi = calculateBMI(record.weight, record.height);
      this.bmiCategory = getBMICategory(this.bmi);
    } else {
      this.bmi = 0;
      this.bmiCategory = '';
    }
    this.isLoading = false;
  }

  /**
   * åˆ·æ–°æ•°æ®
   */
  async refreshData() {
    await this.loadTodayData();
    this.animateCards();
  }

  /**
   * æ›´æ–°ä¸»é¢˜é¢œè‰²
   */
  updateColors() {
    this.colors = getThemeColors();
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('å¥åº·è¿½è¸ª')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.colors.textPrimary)

        // åˆ·æ–°æŒ‰é’®
        Text('âŸ³')
          .fontSize(24)
          .fontColor(this.colors.primary)
          .rotate({ angle: this.isLoading ? 360 : 0 })
          .animation({
            duration: 1000,
            curve: Curve.Linear,
            iterations: this.isLoading ? -1 : 0
          })
          .onClick(() => {
            this.refreshData();
          })
      }
      .width('100%')
      .height(60)
      .padding({ left: 20, right: 20 })
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)

      Scroll() {
        Column() {
          // æ—¥æœŸå’Œé—®å€™è¯­
          this.buildGreetingSection()

          // ä»Šæ—¥æ•°æ®æ¦‚è§ˆ
          if (this.todayRecord) {
            this.buildTodayDataSection()
          } else {
            this.buildEmptyDataHint()
          }

          // ä»Šæ—¥ç›®æ ‡è¿›åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
          this.buildTodayGoalsSection()

          // è®°å½•æŒ‰é’®
          this.buildRecordButton()
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.colors.background)
  }

  /**
   * é—®å€™è¯­éƒ¨åˆ†
   */
  @Builder
  buildGreetingSection() {
    Column() {
      Text(this.getGreeting())
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.colors.textPrimary)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 5 })

      Text(this.currentDate)
        .fontSize(14)
        .fontColor(this.colors.textTertiary)
        .alignSelf(ItemAlign.Start)
    }
    .width('100%')
    .margin({ bottom: 25 })
  }

  /**
   * è·å–é—®å€™è¯­
   */
  getGreeting(): string {
    const hour = new Date().getHours();
    if (hour < 6) return 'å¤œæ·±äº†';
    if (hour < 12) return 'æ—©ä¸Šå¥½';
    if (hour < 14) return 'ä¸­åˆå¥½';
    if (hour < 18) return 'ä¸‹åˆå¥½';
    return 'æ™šä¸Šå¥½';
  }

  /**
   * ä»Šæ—¥æ•°æ®æ¦‚è§ˆ
   */
  @Builder
  buildTodayDataSection() {
    Column() {
      Text('ä»Šæ—¥æ•°æ®')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.colors.textPrimary)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 15 })

      // å¥åº·æ•°æ®å¡ç‰‡
      this.buildHealthDataCards()

      // BMI æ˜¾ç¤º
      if (this.bmi > 0) {
        this.buildBMICard()
      }
    }
    .width('100%')
    .margin({ bottom: 25 })
  }

  /**
   * ç©ºæ•°æ®æç¤º
   */
  @Builder
  buildEmptyDataHint() {
    Column() {
      Text('ğŸ“')
        .fontSize(48)
        .margin({ bottom: 15 })

      Text('è¿˜æ²¡æœ‰è®°å½•ä»Šæ—¥æ•°æ®')
        .fontSize(16)
        .fontColor(this.colors.textSecondary)
        .margin({ bottom: 5 })

      Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è®°å½•')
        .fontSize(14)
        .fontColor(this.colors.textTertiary)
    }
    .width('100%')
    .padding({ top: 40, bottom: 40 })
    .backgroundColor(this.colors.surface)
    .borderRadius(16)
    .margin({ bottom: 25 })
  }

  /**
   * ä»Šæ—¥ç›®æ ‡è¿›åº¦
   */
  @Builder
  buildTodayGoalsSection() {
    // TODO: æ˜¾ç¤ºä»Šæ—¥ç›®æ ‡å®Œæˆæƒ…å†µ
    // è¿™é‡Œå¯ä»¥æ˜¾ç¤º"ä»Šæ—¥å·²å®Œæˆ2/3ä¸ªç›®æ ‡"ç­‰ä¿¡æ¯
  }

  /**
   * è®°å½•æŒ‰é’®
   */
  @Builder
  buildRecordButton() {
    Button(this.todayRecord ? 'æ›´æ–°ä»Šæ—¥æ•°æ®' : 'è®°å½•ä»Šæ—¥æ•°æ®')
      .width('100%')
      .height(56)
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .backgroundColor(this.colors.primary)
      .borderRadius(28)
      .onClick(() => {
        router.pushUrl({
          url: 'pages/RecordPage'
        });
      })
  }

  /**
   * æ„å»ºå¥åº·æ•°æ®å¡ç‰‡
   */
  @Builder
  buildHealthDataCards() {
    Column() {
      // ç¬¬ä¸€è¡Œï¼šä½“é‡å’Œèº«é«˜
      Row() {
        this.buildDataCard('ä½“é‡', this.todayRecord?.weight?.toString() || '--', 'kg', '#FF6B6B')
        this.buildDataCard('èº«é«˜', this.todayRecord?.height?.toString() || '--', 'cm', '#4ECDC4')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 15 })

      // ç¬¬äºŒè¡Œï¼šè¡€å‹å’Œå¿ƒç‡
      Row() {
        this.buildDataCard('æ”¶ç¼©å‹',
          this.todayRecord?.bloodPressureHigh?.toString() || '--', 'mmHg', '#45B7D1')
        this.buildDataCard('å¿ƒç‡', this.todayRecord?.heartRate?.toString() || '--', 'bpm', '#96CEB4')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 15 })

      // ç¬¬ä¸‰è¡Œï¼šæ­¥æ•°å’Œç¡çœ 
      Row() {
        this.buildDataCard('æ­¥æ•°', this.todayRecord?.steps?.toString() || '--', 'æ­¥', '#FFEAA7')
        this.buildDataCard('ç¡çœ ', this.todayRecord?.sleepHours?.toString() || '--', 'å°æ—¶', '#DFE6E9')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
  }

  /**
   * æ„å»ºå•ä¸ªæ•°æ®å¡ç‰‡
   */
  @Builder
  buildDataCard(title: string, value: string, unit: string, color: string) {
    Column() {
      Text(title)
        .fontSize(14)
        .fontColor(this.colors.textTertiary)
        .margin({ bottom: 10 })

      Row() {
        Text(value)
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(color)

        Text(unit)
          .fontSize(14)
          .fontColor(this.colors.textTertiary)
          .margin({ left: 5, bottom: 5 })
          .alignSelf(ItemAlign.End)
      }
    }
    .width('48%')
    .height(100)
    .backgroundColor(this.colors.surface)
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .shadow({
      radius: 8,
      color: this.colors.shadow,
      offsetX: 0,
      offsetY: 2
    })
    .scale({ x: this.scaleValues[0], y: this.scaleValues[0] })
    .animation({
      duration: 200,
      curve: Curve.EaseOut
    })
  }

  /**
   * æ„å»ºBMIå¡ç‰‡
   */
  @Builder
  buildBMICard() {
    Column() {
      Text('ä½“é‡æŒ‡æ•° (BMI)')
        .fontSize(16)
        .fontColor(this.colors.textSecondary)
        .margin({ bottom: 10 })

      Row() {
        Text(this.bmi.toString())
          .fontSize(36)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.colors.error)

        Column() {
          Text(this.bmiCategory)
            .fontSize(18)
            .fontColor(this.colors.error)
            .fontWeight(FontWeight.Medium)
        }
        .margin({ left: 20 })
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor(this.colors.surface)
    .borderRadius(12)
    .margin({ top: 15 })
    .shadow({
      radius: 8,
      color: this.colors.shadow,
      offsetX: 0,
      offsetY: 2
    })
  }
}
