/**
 * åº”ç”¨ä¸»å…¥å£é¡µé¢
 * ä½¿ç”¨Tabsç»„ä»¶å®ç°åº•éƒ¨å¯¼èˆªæ 
 */
import { HomePage } from './HomePage';
import { TrendsPage } from './TrendsPage';
import { ProfilePage } from './ProfilePage';
import { ThemeManager, ThemeColors, getThemeColors } from '../utils/ThemeManager';
import { window } from '@kit.ArkUI';

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State refreshKey: number = 0; // ç”¨äºè§¦å‘å­ç»„ä»¶åˆ·æ–°
  @StorageLink('currentTabIndex') @Watch('onStorageTabIndexChange') storageTabIndex: number = 0;
  @StorageProp('themeChanged') @Watch('updateColors') themeChanged: number = 0;
  @State colors: ThemeColors = getThemeColors();
  private themeManager: ThemeManager = ThemeManager.getInstance();

  aboutToAppear() {
    // åˆå§‹åŒ–AppStorage
    if (!AppStorage.has('currentTabIndex')) {
      AppStorage.setOrCreate('currentTabIndex', 0);
    }
    // è®¾ç½®çŠ¶æ€æ é¢œè‰²
    this.setStatusBarColor();
  }

  onStorageTabIndexChange() {
    // å½“AppStorageä¸­çš„å€¼å˜åŒ–æ—¶ï¼Œæ›´æ–°å½“å‰ç´¢å¼•
    this.currentIndex = this.storageTabIndex;
  }

  /**
   * æ›´æ–°ä¸»é¢˜é¢œè‰²
   */
  updateColors() {
    this.colors = getThemeColors();
    this.setStatusBarColor();
  }

  /**
   * è®¾ç½®çŠ¶æ€æ é¢œè‰²
   */
  async setStatusBarColor() {
    try {
      const windowClass = await window.getLastWindow(getContext(this));
      const isDark = this.themeManager.isDark();

      // è®¾ç½®çŠ¶æ€æ èƒŒæ™¯é¢œè‰²
      await windowClass.setWindowSystemBarProperties({
        statusBarContentColor: isDark ? '#FFFFFF' : '#000000', // çŠ¶æ€æ æ–‡å­—é¢œè‰²
        navigationBarContentColor: isDark ? '#FFFFFF' : '#000000', // å¯¼èˆªæ æŒ‰é’®é¢œè‰²
        statusBarColor: this.colors.background, // çŠ¶æ€æ èƒŒæ™¯è‰²
        navigationBarColor: this.colors.surface // å¯¼èˆªæ èƒŒæ™¯è‰²ï¼ˆåº•éƒ¨è™šæ‹ŸæŒ‰é”®åŒºåŸŸï¼‰
      });
    } catch (err) {
      console.error('Failed to set status bar color:', JSON.stringify(err));
    }
  }

  build() {
    Column() {
      // ä½¿ç”¨Tabsç»„ä»¶å®ç°åº•éƒ¨å¯¼èˆª
      Tabs({ barPosition: BarPosition.End, index: this.currentIndex }) {
        // é¦–é¡µæ ‡ç­¾
        TabContent() {
          HomePage()
        }
        .tabBar(this.buildTabBarItem(0, 'é¦–é¡µ', 'ğŸ '))

        // è¶‹åŠ¿æ ‡ç­¾
        TabContent() {
          TrendsPage()
        }
        .tabBar(this.buildTabBarItem(1, 'è¶‹åŠ¿', 'ğŸ“Š'))

        // æˆ‘çš„æ ‡ç­¾
        TabContent() {
          ProfilePage()
        }
        .tabBar(this.buildTabBarItem(2, 'æˆ‘çš„', 'ğŸ‘¤'))
      }
      .width('100%')
      .height('100%')
      .barMode(BarMode.Fixed)
      .barBackgroundColor(this.colors.surface)
      .onChange((index: number) => {
        this.currentIndex = index;
        AppStorage.setOrCreate('currentTabIndex', index);
        // åˆ‡æ¢æ ‡ç­¾æ—¶åˆ·æ–°å¯¹åº”é¡µé¢
        this.refreshKey++;
      })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.colors.background)
  }

  /**
   * æ„å»ºåº•éƒ¨å¯¼èˆªæ é¡¹
   * @param index æ ‡ç­¾ç´¢å¼•
   * @param title æ ‡ç­¾æ ‡é¢˜
   * @param icon æ ‡ç­¾å›¾æ ‡(æ–‡æœ¬)
   */
  @Builder
  buildTabBarItem(index: number, title: string, icon: string) {
    Column() {
      Text(icon)
        .fontSize(24)
        .fontColor(this.currentIndex === index ? this.colors.primary : this.colors.textTertiary)
        .margin({ bottom: 4 })

      Text(title)
        .fontSize(12)
        .fontColor(this.currentIndex === index ? this.colors.primary : this.colors.textTertiary)
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
}