/**
 * æˆ‘çš„é¡µé¢
 * å±•ç¤ºä¸ªäººä¿¡æ¯ã€ç›®æ ‡ç®¡ç†å’Œè®¾ç½®
 */
import { HealthGoal, GoalType, GoalDirection, UserInfo } from '../models/HealthRecord';
import { DataManager } from '../utils/DataManager';
import { DataInitializer } from '../utils/DataInitializer';
import { updateGoalsProgress } from '../utils/CommonUtils';
import { ThemeManager, ThemeType, ThemeColors, getThemeColors } from '../utils/ThemeManager';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

@Component
export struct ProfilePage {
  @State goals: HealthGoal[] = [];
  @State userName: string = 'ç”¨æˆ·';
  @State userInfo: UserInfo = {
    nickname: 'ç”¨æˆ·',
    avatar: 'ðŸ‘¨',
    gender: 'male',
    signature: 'åšæŒè®°å½•å¥åº·æ•°æ®'
  };
  @State totalRecords: number = 0;
  @State clickCount: number = 0; // ç”¨äºŽéšè—åŠŸèƒ½
  @StorageProp('appTheme') @Watch('onThemeChange') currentTheme: string = 'light';
  @StorageProp('themeChanged') @Watch('updateColors') themeChanged: number = 0;
  @State colors: ThemeColors = getThemeColors();
  private dataManager: DataManager = DataManager.getInstance();
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private intervalId: number = -1;

  aboutToAppear() {
    this.loadData();
    // å®šæ—¶åˆ·æ–°æ•°æ®ï¼ˆæ¯5ç§’ï¼‰
    this.intervalId = setInterval(() => {
      this.loadData();
    }, 5000);
  }

  aboutToDisappear() {
    // æ¸…é™¤å®šæ—¶å™¨
    if (this.intervalId !== -1) {
      clearInterval(this.intervalId);
    }
  }

  /**
   * åŠ è½½æ•°æ®
   */
  async loadData() {
    // å…ˆæ›´æ–°ç›®æ ‡è¿›åº¦
    await updateGoalsProgress();

    // ç„¶åŽåŠ è½½æœ€æ–°æ•°æ®
    this.goals = await this.dataManager.getAllHealthGoals();
    const records = await this.dataManager.getAllHealthRecords();
    this.totalRecords = records.length;

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    this.userInfo = await this.dataManager.getUserInfo();
    this.userName = this.userInfo.nickname;
  }

  /**
   * è®¡ç®—ç›®æ ‡å®Œæˆåº¦
   */
  calculateProgress(goal: HealthGoal): number {
    if (goal.targetValue === 0) return 0;
    return Math.min(100, Math.floor((goal.currentValue / goal.targetValue) * 100));
  }

  /**
   * ç¼–è¾‘ç›®æ ‡
   */
  editGoal(goal: HealthGoal) {
    router.pushUrl({
      url: 'pages/GoalEditPage',
      params: {
        goal: goal
      }
    });
  }

  /**
   * ç¡®è®¤åˆ é™¤ç›®æ ‡
   */
  confirmDeleteGoal(goal: HealthGoal) {
    promptAction.showDialog({
      title: 'åˆ é™¤ç›®æ ‡',
      message: `ç¡®å®šè¦åˆ é™¤"${this.getGoalTypeName(goal.type)}"å—ï¼Ÿ`,
      buttons: [
        { text: 'å–æ¶ˆ', color: '#999999' },
        { text: 'åˆ é™¤', color: '#FF6B6B' }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        await this.deleteGoal(goal.id);
      }
    });
  }

  /**
   * åˆ é™¤ç›®æ ‡
   */
  async deleteGoal(goalId: string) {
    const success = await this.dataManager.deleteHealthGoal(goalId);
    if (success) {
      promptAction.showToast({
        message: 'ç›®æ ‡å·²åˆ é™¤',
        duration: 2000
      });
      this.loadData();
    } else {
      promptAction.showToast({
        message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  /**
   * ä¸»é¢˜å˜åŒ–å›žè°ƒ
   */
  onThemeChange() {
    // ä¸»é¢˜å·²å˜åŒ–ï¼Œç»„ä»¶ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“
  }

  /**
   * æ›´æ–°é¢œè‰²
   */
  updateColors() {
    this.colors = getThemeColors();
  }

  /**
   * åˆ‡æ¢ä¸»é¢˜
   */
  toggleTheme() {
    this.themeManager.toggleTheme();
    const isDark = this.themeManager.isDark();
    promptAction.showToast({
      message: isDark ? 'å·²åˆ‡æ¢åˆ°æš—è‰²æ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼',
      duration: 2000
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ 
      Row() {
        Text('æˆ‘çš„')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.colors.textPrimary)
      }
      .width('100%')
      .height(60)
      .padding({ left: 20, right: 20 })
      .justifyContent(FlexAlign.Start)
      .alignItems(VerticalAlign.Center)

      Scroll() {
        Column() {
          // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
          this.buildUserInfoCard()

          // ç»Ÿè®¡ä¿¡æ¯
          this.buildStatisticsSection()

          // å¥åº·ç›®æ ‡
          this.buildGoalsSection()

          // è®¾ç½®é€‰é¡¹
          this.buildSettingsSection()
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.colors.background)
  }

  /**
   * æž„å»ºç”¨æˆ·ä¿¡æ¯å¡ç‰‡
   */
  @Builder
  buildUserInfoCard() {
    Row() {
      // å¤´åƒï¼ˆè¿žç»­ç‚¹å‡»5æ¬¡æ˜¾ç¤ºæ•°æ®ç®¡ç†é€‰é¡¹ï¼‰
      Column() {
        Text(this.userInfo.avatar || 'ðŸ‘¨')
          .fontSize(30)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
      }
        .width(60)
        .height(60)
        .backgroundColor(this.colors.primary)
        .borderRadius(30)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.clickCount++;
          if (this.clickCount >= 5) {
            this.showDataManagementDialog();
            this.clickCount = 0;
          }
        })

      Column() {
        Row() {
          Text(this.userInfo.nickname || 'ç”¨æˆ·')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.colors.textPrimary)

          Text('âœŽ') // ä½¿ç”¨æ–‡æœ¬ç¬¦å·æ›¿ä»£å›¾æ ‡
            .fontSize(16)
            .fontColor(this.colors.textSecondary)
            .margin({ left: 8 })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/ProfileEditPage'
              });
            })
        }

        Text(this.userInfo.signature || 'åšæŒè®°å½•å¥åº·æ•°æ®')
          .fontSize(14)
          .fontColor(this.colors.textTertiary)
          .margin({ top: 5 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 15 })
      .layoutWeight(1)
      .onClick(() => {
        router.pushUrl({
          url: 'pages/ProfileEditPage'
        });
      })
    }
    .width('100%')
    .padding(20)
    .backgroundColor(this.colors.surface)
    .borderRadius(12)
    .margin({ bottom: 20 })
    .shadow({
      radius: 8,
      color: this.colors.shadow,
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * æ˜¾ç¤ºæ•°æ®ç®¡ç†å¯¹è¯æ¡†
   */
  async showDataManagementDialog() {
    promptAction.showDialog({
      title: 'æ•°æ®ç®¡ç†',
      message: 'é€‰æ‹©æ“ä½œ',
      buttons: [
        { text: 'é‡æ–°ç”Ÿæˆæ•°æ®', color: '#4ECDC4' },
        { text: 'æ¸…ç©ºæ‰€æœ‰æ•°æ®', color: '#FF6B6B' },
        { text: 'å–æ¶ˆ', color: '#999999' }
      ]
    }).then(async (result) => {
      if (result.index === 0) {
        // é‡æ–°ç”Ÿæˆæ•°æ®
        const initializer = new DataInitializer();
        await initializer.clearAllData();
        await initializer.initializeMockData();
        promptAction.showToast({
          message: 'æ•°æ®å·²é‡æ–°ç”Ÿæˆ',
          duration: 2000
        });
        this.loadData();
      } else if (result.index === 1) {
        // æ¸…ç©ºæ•°æ®
        const initializer = new DataInitializer();
        await initializer.clearAllData();
        promptAction.showToast({
          message: 'æ•°æ®å·²æ¸…ç©º',
          duration: 2000
        });
        this.loadData();
      }
    });
  }

  /**
   * æž„å»ºç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ
   */
  @Builder
  buildStatisticsSection() {
    Column() {
      Text('æ•°æ®ç»Ÿè®¡')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.colors.textPrimary)
        .margin({ bottom: 15 })
        .alignSelf(ItemAlign.Start)

      Row() {
        this.buildStatItem('è®°å½•å¤©æ•°', this.totalRecords.toString(), this.colors.error)
        this.buildStatItem('å®Œæˆç›®æ ‡', this.goals.filter(g => g.isCompleted).length.toString(), this.colors.primary)
        this.buildStatItem('è¿›è¡Œä¸­', this.goals.filter(g => !g.isCompleted).length.toString(), this.colors.secondary)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .margin({ bottom: 20 })
  }

  /**
   * æž„å»ºç»Ÿè®¡é¡¹
   */
  @Builder
  buildStatItem(label: string, value: string, color: string) {
    Column() {
      Text(value)
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)

      Text(label)
        .fontSize(12)
        .fontColor(this.colors.textTertiary)
        .margin({ top: 5 })
    }
    .width('30%')
    .padding(15)
    .backgroundColor(this.colors.surface)
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: this.colors.shadow,
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * æž„å»ºç›®æ ‡åŒºåŸŸ
   */
  @Builder
  buildGoalsSection() {
    Column() {
      Row() {
        Text('æˆ‘çš„ç›®æ ‡')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.colors.textPrimary)

        Text('æ·»åŠ ')
          .fontSize(14)
          .fontColor(this.colors.primary)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/GoalEditPage'
            });
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 15 })

      if (this.goals.length === 0) {
        Text('æš‚æ— å¥åº·ç›®æ ‡ï¼Œç‚¹å‡»æ·»åŠ æ–°ç›®æ ‡')
          .fontSize(14)
          .fontColor(this.colors.textTertiary)
          .padding(20)
          .width('100%')
          .backgroundColor(this.colors.surface)
          .borderRadius(12)
      } else {
        ForEach(this.goals, (goal: HealthGoal) => {
          this.buildGoalItem(goal);
        }, (goal: HealthGoal) => goal.id)
      }
    }
    .margin({ bottom: 20 })
  }

  /**
   * æž„å»ºç›®æ ‡é¡¹
   */
  @Builder
  buildGoalItem(goal: HealthGoal) {
    Column() {
      Row() {
        Column() {
          Text(this.getGoalTypeName(goal.type))
            .fontSize(16)
            .fontColor(this.colors.textPrimary)
            .fontWeight(FontWeight.Medium)
            .alignSelf(ItemAlign.Start)

          Text(this.getDirectionLabel(goal.direction || GoalDirection.INCREASE))
            .fontSize(12)
            .fontColor(this.colors.textSecondary)
            .margin({ top: 3 })
            .alignSelf(ItemAlign.Start)
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        Text(goal.isCompleted ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­')
          .fontSize(12)
          .fontColor(goal.isCompleted ? this.colors.success : this.colors.error)
          .padding({ top: 4, bottom: 4, left: 10, right: 10 })
          .backgroundColor(goal.isCompleted ? (this.themeManager.isDark() ? '#1A3A38' : '#E8F8F5') : (this.themeManager.isDark() ? '#3A1F1F' : '#FFE8E8'))
          .borderRadius(10)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Top)
      .margin({ bottom: 10 })

      Row() {
        Text(`${goal.currentValue} / ${goal.targetValue} ${goal.unit}`)
          .fontSize(14)
          .fontColor(this.colors.textSecondary)

        Text(`${this.calculateProgress(goal)}%`)
          .fontSize(14)
          .fontColor(this.colors.primary)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ bottom: 10 })

      // è¿›åº¦æ¡
      Row() {
        Row()
          .width(`${this.calculateProgress(goal)}%`)
          .height('100%')
          .backgroundColor(this.colors.primary)
          .borderRadius(4)
      }
      .width('100%')
      .height(8)
      .backgroundColor(this.themeManager.isDark() ? '#1A3A38' : '#E8F8F5')
      .borderRadius(4)
      .margin({ bottom: 10 })

      // æ“ä½œæŒ‰é’®
      Row() {
        Text('ç¼–è¾‘')
          .fontSize(14)
          .fontColor(this.colors.primary)
          .padding({ top: 5, bottom: 5, left: 15, right: 15 })
          .backgroundColor(this.themeManager.isDark() ? '#1A3A38' : '#E8F8F5')
          .borderRadius(8)
          .onClick(() => {
            this.editGoal(goal);
          })

        Text('åˆ é™¤')
          .fontSize(14)
          .fontColor(this.colors.error)
          .padding({ top: 5, bottom: 5, left: 15, right: 15 })
          .backgroundColor(this.themeManager.isDark() ? '#3A1F1F' : '#FFE8E8')
          .borderRadius(8)
          .margin({ left: 10 })
          .onClick(() => {
            this.confirmDeleteGoal(goal);
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.End)
    }
    .width('100%')
    .padding(15)
    .backgroundColor(this.colors.surface)
    .borderRadius(12)
    .margin({ bottom: 10 })
    .shadow({
      radius: 8,
      color: this.colors.shadow,
      offsetX: 0,
      offsetY: 2
    })
  }

  /**
   * èŽ·å–ç›®æ ‡ç±»åž‹åç§°
   */
  getGoalTypeName(type: GoalType): string {
    switch (type) {
      case GoalType.WEIGHT:
        return 'ç›®æ ‡ä½“é‡';
      case GoalType.STEPS:
        return 'æ¯æ—¥æ­¥æ•°';
      case GoalType.WATER:
        return 'æ¯æ—¥é¥®æ°´';
      case GoalType.SLEEP:
        return 'ç¡çœ æ—¶é•¿';
      case GoalType.EXERCISE:
        return 'è¿åŠ¨æ—¶é•¿';
      default:
        return 'æœªçŸ¥ç›®æ ‡';
    }
  }

  /**
   * èŽ·å–ç›®æ ‡æ–¹å‘æè¿°
   */
  getGoalDirectionDesc(goal: HealthGoal): string {
    const direction = goal.direction || GoalDirection.INCREASE;
    const typeName = this.getGoalTypeName(goal.type);

    switch (direction) {
      case GoalDirection.DECREASE:
        return `${typeName}ï¼ˆå‡å°‘åˆ°${goal.targetValue}${goal.unit}ï¼‰`;
      case GoalDirection.INCREASE:
        return `${typeName}ï¼ˆå¢žåŠ åˆ°${goal.targetValue}${goal.unit}ï¼‰`;
      case GoalDirection.REACH:
        return `${typeName}ï¼ˆè¾¾åˆ°${goal.targetValue}${goal.unit}ï¼‰`;
      default:
        return typeName;
    }
  }

  /**
   * èŽ·å–ç›®æ ‡æ–¹å‘æ ‡ç­¾
   */
  getDirectionLabel(direction: GoalDirection): string {
    switch (direction) {
      case GoalDirection.DECREASE:
        return 'å‡å°‘ç›®æ ‡';
      case GoalDirection.INCREASE:
        return 'å¢žåŠ ç›®æ ‡';
      case GoalDirection.REACH:
        return 'è¾¾åˆ°ç›®æ ‡';
      default:
        return 'å¢žåŠ ç›®æ ‡';
    }
  }

  /**
   * æž„å»ºè®¾ç½®åŒºåŸŸ
   */
  @Builder
  buildSettingsSection() {
    Column() {
      Text('è®¾ç½®')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.colors.textPrimary)
        .margin({ bottom: 15 })
        .alignSelf(ItemAlign.Start)

      // ä¸»é¢˜åˆ‡æ¢
      this.buildThemeToggle()

      this.buildSettingItem('æé†’è®¾ç½®', () => {
        router.pushUrl({
          url: 'pages/ReminderSettingsPage'
        });
      })

      this.buildSettingItem('æ•°æ®å¯¼å‡º', () => {
        router.pushUrl({
          url: 'pages/ExportPage'
        });
      })

      this.buildSettingItem('å…³äºŽåº”ç”¨', () => {
        promptAction.showDialog({
          title: 'å…³äºŽåº”ç”¨',
          message: 'HealthTracker v1.4\n\nä¸ªäººå¥åº·ç®¡ç†åŠ©æ‰‹\n\nå¸®åŠ©æ‚¨è®°å½•å’Œè¿½è¸ªæ—¥å¸¸å¥åº·æ•°æ®\n\nâœ¨ æ”¯æŒæµ…è‰²/æš—è‰²ä¸»é¢˜åˆ‡æ¢',
          buttons: [{ text: 'ç¡®å®š', color: '#4ECDC4' }]
        });
      })
    }
  }

  /**
   * æž„å»ºä¸»é¢˜åˆ‡æ¢å¼€å…³
   */
  @Builder
  buildThemeToggle() {
    Row() {
      Column() {
        Text('æš—è‰²æ¨¡å¼')
          .fontSize(15)
          .fontColor(this.colors.textPrimary)

        Text(this.themeManager.isDark() ? 'æŠ¤çœ¼æ¨¡å¼å·²å¼€å¯' : 'ç‚¹å‡»å¼€å¯æŠ¤çœ¼æ¨¡å¼')
          .fontSize(12)
          .fontColor(this.colors.textTertiary)
          .margin({ top: 3 })
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)

      // åˆ‡æ¢å¼€å…³
      Toggle({ type: ToggleType.Switch, isOn: this.themeManager.isDark() })
        .selectedColor(this.colors.primary)
        .onChange((isOn: boolean) => {
          this.toggleTheme();
        })
    }
    .width('100%')
    .height(60)
    .padding({ left: 15, right: 15 })
    .backgroundColor(this.colors.surface)
    .borderRadius(8)
    .justifyContent(FlexAlign.SpaceBetween)
    .margin({ bottom: 10 })
  }

  /**
   * æž„å»ºè®¾ç½®é¡¹
   */
  @Builder
  buildSettingItem(label: string, onClick: () => void) {
    Row() {
      Text(label)
        .fontSize(15)
        .fontColor(this.colors.textPrimary)

      Text('>')
        .fontSize(16)
        .fontColor(this.colors.textTertiary)
    }
    .width('100%')
    .height(50)
    .padding({ left: 15, right: 15 })
    .backgroundColor(this.colors.surface)
    .borderRadius(8)
    .justifyContent(FlexAlign.SpaceBetween)
    .margin({ bottom: 10 })
    .onClick(() => {
      onClick();
    })
  }
}
