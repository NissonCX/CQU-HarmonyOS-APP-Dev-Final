/**
 * ä¸ªäººä¿¡æ¯ç¼–è¾‘é¡µé¢
 */
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { UserInfo } from '../models/HealthRecord';
import { DataManager } from '../utils/DataManager';
import { ThemeManager, ThemeColors, getThemeColors } from '../utils/ThemeManager';

@Entry
@Component
struct ProfileEditPage {
  @State userInfo: UserInfo = {
    nickname: '',
    avatar: '',
    gender: 'male',
    signature: ''
  };
  @State colors: ThemeColors = getThemeColors();
  @StorageProp('themeChanged') @Watch('updateColors') themeChanged: number = 0;

  private dataManager: DataManager = DataManager.getInstance();
  private themeManager: ThemeManager = ThemeManager.getInstance();

  // é¢„è®¾å¤´åƒåˆ—è¡¨
  private avatars: string[] = ['ğŸ‘¨', 'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘§', 'ğŸ‘¦', 'ğŸ§“', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ±', 'ğŸ¶', 'ğŸ°', 'ğŸ¦Š', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦'];

  async aboutToAppear() {
    this.userInfo = await this.dataManager.getUserInfo();
  }

  updateColors() {
    this.colors = getThemeColors();
  }

  async saveProfile() {
    if (!this.userInfo.nickname.trim()) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥æ˜µç§°',
        duration: 2000
      });
      return;
    }

    const success = await this.dataManager.saveUserInfo(this.userInfo);
    if (success) {
      promptAction.showToast({
        message: 'ä¿å­˜æˆåŠŸ',
        duration: 2000
      });
      setTimeout(() => {
        router.back();
      }, 500);
    } else {
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('<') // ä½¿ç”¨æ–‡æœ¬ç¬¦å·æ›¿ä»£å›¾æ ‡
          .fontSize(24)
          .fontColor(this.colors.textPrimary)
          .onClick(() => {
            router.back();
          })

        Text('ç¼–è¾‘ä¸ªäººä¿¡æ¯')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.colors.textPrimary)
          .margin({ left: 16 })

        Blank()

        Text('ä¿å­˜')
          .fontSize(16)
          .fontColor(this.colors.primary)
          .fontWeight(FontWeight.Medium)
          .onClick(() => {
            this.saveProfile();
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20 })
      .backgroundColor(this.colors.background)

      Scroll() {
        Column({ space: 20 }) {
          // å¤´åƒé€‰æ‹©
          Column() {
            Text('é€‰æ‹©å¤´åƒ')
              .fontSize(14)
              .fontColor(this.colors.textSecondary)
              .margin({ bottom: 10 })
              .alignSelf(ItemAlign.Start)

            Grid() {
              ForEach(this.avatars, (avatar: string) => {
                GridItem() {
                  Text(avatar)
                    .fontSize(30)
                    .width(50)
                    .height(50)
                    .textAlign(TextAlign.Center)
                    .backgroundColor(this.userInfo.avatar === avatar ? this.colors.primary + '33' : 'transparent')
                    .borderRadius(25)
                    .border({
                      width: this.userInfo.avatar === avatar ? 2 : 0,
                      color: this.colors.primary
                    })
                    .onClick(() => {
                      this.userInfo.avatar = avatar;
                    })
                }
              })
            }
            .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
            .rowsGap(10)
            .height(180)
          }
          .padding(15)
          .backgroundColor(this.colors.surface)
          .borderRadius(12)

          // åŸºæœ¬ä¿¡æ¯è¡¨å•
          Column({ space: 15 }) {
            // æ˜µç§°
            Column() {
              Text('æ˜µç§°')
                .fontSize(14)
                .fontColor(this.colors.textSecondary)
                .margin({ bottom: 8 })
                .alignSelf(ItemAlign.Start)

              TextInput({ text: this.userInfo.nickname, placeholder: 'è¯·è¾“å…¥æ˜µç§°' })
                .width('100%')
                .height(48)
                .backgroundColor(this.themeManager.isDark() ? '#1A1A1A' : '#F5F5F5')
                .borderRadius(8)
                .fontColor(this.colors.textPrimary)
                .onChange((value: string) => {
                  this.userInfo.nickname = value;
                })
            }

            // ä¸ªæ€§ç­¾å
            Column() {
              Text('ä¸ªæ€§ç­¾å')
                .fontSize(14)
                .fontColor(this.colors.textSecondary)
                .margin({ bottom: 8 })
                .alignSelf(ItemAlign.Start)

              TextInput({ text: this.userInfo.signature, placeholder: 'å†™ä¸€å¥é¼“åŠ±è‡ªå·±çš„è¯' })
                .width('100%')
                .height(48)
                .backgroundColor(this.themeManager.isDark() ? '#1A1A1A' : '#F5F5F5')
                .borderRadius(8)
                .fontColor(this.colors.textPrimary)
                .onChange((value: string) => {
                  this.userInfo.signature = value;
                })
            }

            // æ€§åˆ«
            Column() {
              Text('æ€§åˆ«')
                .fontSize(14)
                .fontColor(this.colors.textSecondary)
                .margin({ bottom: 8 })
                .alignSelf(ItemAlign.Start)

              Row({ space: 15 }) {
                this.GenderOption('male', 'ç”· ğŸ‘¨')
                this.GenderOption('female', 'å¥³ ğŸ‘©')
              }
              .width('100%')
            }

            // èº«é«˜
            Column() {
              Text('èº«é«˜ (cm)')
                .fontSize(14)
                .fontColor(this.colors.textSecondary)
                .margin({ bottom: 8 })
                .alignSelf(ItemAlign.Start)

              TextInput({ text: this.userInfo.height ? this.userInfo.height.toString() : '', placeholder: '0' })
                .width('100%')
                .height(48)
                .type(InputType.Number)
                .backgroundColor(this.themeManager.isDark() ? '#1A1A1A' : '#F5F5F5')
                .borderRadius(8)
                .fontColor(this.colors.textPrimary)
                .onChange((value: string) => {
                  const val = parseFloat(value);
                  if (!isNaN(val)) {
                    this.userInfo.height = val;
                  }
                })
            }

            // ç›®æ ‡ä½“é‡
            Column() {
              Text('ç›®æ ‡ä½“é‡ (kg)')
                .fontSize(14)
                .fontColor(this.colors.textSecondary)
                .margin({ bottom: 8 })
                .alignSelf(ItemAlign.Start)

              TextInput({ text: this.userInfo.targetWeight ? this.userInfo.targetWeight.toString() : '', placeholder: '0' })
                .width('100%')
                .height(48)
                .type(InputType.Number)
                .backgroundColor(this.themeManager.isDark() ? '#1A1A1A' : '#F5F5F5')
                .borderRadius(8)
                .fontColor(this.colors.textPrimary)
                .onChange((value: string) => {
                  const val = parseFloat(value);
                  if (!isNaN(val)) {
                    this.userInfo.targetWeight = val;
                  }
                })
            }
          }
          .padding(15)
          .backgroundColor(this.colors.surface)
          .borderRadius(12)
        }
        .width('100%')
        .padding(20)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.colors.background)
  }

  @Builder
  GenderOption(value: string, label: string) {
    Row() {
      Radio({ value: value, group: 'gender' })
        .checked(this.userInfo.gender === value)
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.userInfo.gender = value as 'male' | 'female' | 'other';
          }
        })
      Text(label)
        .fontSize(16)
        .fontColor(this.colors.textPrimary)
    }
  }
}
